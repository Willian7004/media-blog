'''
å†™ä¸€ä¸ªstreamlitç¨‹åºï¼Œå®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š
1.å½“å‰ç›®å½•ä¸‹articlesæ–‡ä»¶å¤¹ä¸­æœ‰å¤šä¸ªåŒ…å«.mdæ–‡ä»¶çš„æ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶å¤¹å‘½ååŒ…å«å¹´ã€æœˆï¼ˆä¾‹å¦‚2025å¹´5æœˆå¯¹åº”çš„æ–‡ä»¶å¤¹å‘½åä¸º202505ï¼‰ï¼Œæ–‡ä»¶å‘½åä¾æ¬¡åŒ…å«å¹´ã€æœˆã€æ—¥å’Œåºå·ï¼ˆä¾‹å¦‚2025å¹´5æœˆ5æ—¥ç¬¬ä¸€ç¯‡åç§°ä¸º2025050501ï¼‰ã€‚.mdæ–‡ä»¶å†…å®¹ç¬¬ä¸€è¡Œä¸ºæ ‡é¢˜ã€‚å½“å‰ç›®å½•ä¸‹filesæ–‡ä»¶å¤¹ä¸­æœ‰ä¸.mdæ–‡ä»¶è·¯å¾„å¯¹åº”çš„æ–‡ä»¶å¤¹ã€‚
2.åœ¨ä¾§è¾¹æ åˆ›å»ºä¸‹æ‹‰èœå•ã€è¾“å…¥æ¡†å’Œä¸¤ä¸ªå¤é€‰æ¡†ã€‚ä¸‹æ‹‰èœå•ç”¨äºé€‰æ‹©æœˆä»½å¯¹åº”çš„æ–‡ä»¶å¤¹ï¼Œè¾ƒæ–°çš„æ’åœ¨å‰é¢ï¼Œç¬¬ä¸€ä¸ªé€‰é¡¹ä¸ºâ€œå…¨éƒ¨â€ï¼Œç”¨äºé€‰æ‹©æ‰€æœ‰æ–‡ä»¶å¤¹ã€‚åœ¨è¾“å…¥æ¡†è¾“å…¥æ–‡å­—ç­›é€‰æ ‡é¢˜åŒ…å«ç‰¹å®šå…³é”®è¯çš„æ–‡ä»¶ï¼Œé€šè¿‡ç©ºæ ¼è¾“å…¥å¤šä¸ªå…³é”®è¯ä»¥ç­›é€‰åŒæ—¶åŒ…å«æ‰€æœ‰å…³é”®è¯çš„æ–‡ä»¶ã€‚ç¬¬ä¸€ä¸ªå¤é€‰æ¡†æ–‡å­—ä¸ºâ€œå…¨æ–‡æœç´¢â€ï¼Œé€‰ä¸­åæœç´¢æ–‡ä»¶å…¨æ–‡ã€‚ç¬¬äºŒä¸ªå¤é€‰æ¡†æ–‡å­—ä¸ºâ€œæ˜¾ç¤ºä¸‹è½½æŒ‰é’®â€ï¼Œé€‰ä¸­ååœ¨é¡µé¢ä¸Šçš„å›¾ç‰‡ä¸‹æ–¹æ·»åŠ ä¸‹è½½æŒ‰é’®ç”¨äºä¸‹è½½å¯¹åº”å›¾ç‰‡ã€‚
3.åœ¨ä¾§è¾¹æ åˆ›å»ºå•é€‰æŒ‰é’®æ–‡å­—ä¸ºæ–‡ä»¶æ ‡é¢˜ï¼Œç”¨äºé€‰ä¸­å¯¹åº”æ–‡ä»¶ã€‚æ–°çš„æ–‡ä»¶æ˜¾ç¤ºåœ¨ä¸Šæ–¹ã€‚åœ¨æ¯ä¸ªæ—¥æœŸçš„æ–‡ä»¶ä¸Šæ–¹æ·»åŠ ä¸€ä¸ªæ–‡å­—ä¸ºå¯¹åº”æ—¥æœŸçš„é€‰é¡¹ï¼Œç”¨äºé€‰ä¸­ç›¸åº”æ—¥æœŸçš„æœ€æ–°æ–‡ä»¶ã€‚
4.é€‰ä¸­æ–‡ä»¶ååœ¨é¡µé¢ä¸Šä½¿ç”¨st.markdownæ˜¾ç¤ºå¯¹åº”çš„æ–‡ä»¶å†…å®¹ï¼ˆåŒ…æ‹¬æ ‡é¢˜ï¼‰,æ’é™¤å›¾ç‰‡å’Œhtmlå†…å®¹ã€‚åœ¨ä¸‹æ–¹æŒ‰æ–‡ä»¶åé¡ºåºåŠ è½½ä¸.mdæ–‡ä»¶å¯¹åº”çš„æ–‡ä»¶å¤¹ä¸­çš„å›¾ç‰‡ã€è§†é¢‘å’ŒéŸ³é¢‘æ–‡ä»¶ï¼Œå…¶ä¸­è§†é¢‘è®¾ä¸ºè‡ªåŠ¨æ’­æ”¾ã€å¾ªç¯æ’­æ”¾ã€‚

æ›´æ–°ï¼š
ä¿®æ”¹ä»¥ä¸Šç¨‹åºï¼Œåœ¨é¡µé¢ä¸Šæ˜¾ç¤ºå›¾ç‰‡æ—¶ï¼Œåˆ†ä¸‰åˆ—æ˜¾ç¤º å®½åº¦<é«˜åº¦ çš„å›¾ç‰‡ï¼Œåˆ†ä¸¤åˆ—æ˜¾ç¤º å®½åº¦=é«˜åº¦ çš„å›¾ç‰‡ï¼Œå…¶å®ƒçš„ä¸åˆ†åˆ—æ˜¾ç¤ºã€‚
'''

import streamlit as st
import os

st.set_page_config(layout="wide")
with st.expander("é¡¹ç›®è¯´æ˜"):
    filepath='README.md'
    with open(filepath, "r", encoding="utf-8") as f:
        content = f.read()
        st.markdown(content)
st.sidebar.title("Media Blog")

import re
from datetime import datetime
from PIL import Image

def get_month_folders():
    """è·å–æ‰€æœ‰ç¬¦åˆæ ¼å¼çš„æœˆä»½æ–‡ä»¶å¤¹"""
    articles_dir = 'articles'
    folders = []
    if not os.path.exists(articles_dir):
        return []
    for d in os.listdir(articles_dir):
        path = os.path.join(articles_dir, d)
        if os.path.isdir(path) and re.match(r'\d{6}', d):
            folders.append(d)
    return sorted(folders, reverse=True)

def parse_article_files(month_folder, keywords, full_text_search):
    """è§£ææŒ‡å®šæœˆä»½ä¸‹çš„æ‰€æœ‰æ–‡ç« æ–‡ä»¶"""
    articles_dir = 'articles'
    month_path = os.path.join(articles_dir, month_folder)
    files = []
    
    for md_file in os.listdir(month_path):
        if not md_file.endswith('.md'):
            continue
            
        file_path = os.path.join(month_path, md_file)
        prefix = md_file[:10] if len(md_file) >= 12 else md_file.split('.')[0]
        
        if not re.match(r'\d{8}\d*', prefix):
            continue
            
        try:
            date = datetime.strptime(prefix[:8], "%Y%m%d").date()
        except ValueError:
            continue

        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
            
        # æå–æ ‡é¢˜
        first_line = content.split('\n', 1)[0]
        title = re.sub(r'^\s*##\s*', '', first_line).strip()
        
        # å…³é”®è¯è¿‡æ»¤
        if keywords:
            search_text = content if full_text_search else title
            if not all(kw.lower() in search_text.lower() for kw in keywords):
                continue
                
        files.append({
            'title': title,
            'date': date,
            'path': file_path,
            'prefix': prefix,
            'content': content,
            'filename': md_file
        })
    
    # æŒ‰æ—¥æœŸå’Œåºå·æ’åº
    return sorted(files, key=lambda x: (x['date'], x['prefix']), reverse=True)

def extract_content(content):
    """æå–å¹¶æ¸…ç†markdownå†…å®¹"""
    # ç§»é™¤æ ‡å‡†Markdownå›¾ç‰‡è¯­æ³• ![alt](url)
    content = re.sub(r'!\[.*?\]\(.*?\)', '', content, flags=re.DOTALL)
    # ç§»é™¤HTMLå›¾ç‰‡ã€è§†é¢‘ã€éŸ³é¢‘æ ‡ç­¾ <img>
    content = re.sub(r'<img\s+.*?>', '', content, flags=re.DOTALL)
    content = re.sub(r'<video\s+.*?>', '', content, flags=re.DOTALL)
    content = re.sub(r'<audio\s+.*?>', '', content, flags=re.DOTALL)
    return content

def main():
    
    # æœˆä»½é€‰æ‹©
    month_folders = get_month_folders()
    selected_month = st.sidebar.selectbox("é€‰æ‹©æœˆä»½", ['å…¨éƒ¨'] + month_folders)
    
    # å…³é”®è¯æœç´¢
    keyword_input = st.sidebar.text_input("å…³é”®è¯æœç´¢ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰", "")
    keywords = [k.strip() for k in keyword_input.split() if k.strip()]
    
    # æœç´¢é€‰é¡¹
    full_text_search = st.sidebar.checkbox("å…¨æ–‡æœç´¢")
    show_download = st.sidebar.checkbox("æ˜¾ç¤ºä¸‹è½½æŒ‰é’®")
    
    # æ”¶é›†æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶
    all_files = []
    if selected_month == 'å…¨éƒ¨':
        for month in month_folders:
            all_files.extend(parse_article_files(month, keywords, full_text_search))
    else:
        all_files = parse_article_files(selected_month, keywords, full_text_search)
    
    if not all_files:
        st.warning("æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶")
        return

    # æŒ‰æ—¥æœŸåˆ†ç»„
    files_by_date = {}
    for file in all_files:
        date_key = file['date'].strftime("%Y-%m-%d")
        if date_key not in files_by_date:
            files_by_date[date_key] = []
        files_by_date[date_key].append(file)
    sorted_dates = sorted(files_by_date.keys(), reverse=True)
    
    # æ„å»ºä¾§è¾¹æ é€‰é¡¹
    sidebar_options = []
    option_to_file = {}
    
    for date_key in sorted_dates:
        date_files = files_by_date[date_key]
        # æ—¥æœŸé€‰é¡¹
        date_option = f"ğŸ“… {date_key}"
        sidebar_options.append(date_option)
        option_to_file[date_option] = date_files[0]  # æœ€æ–°æ–‡ä»¶
        
        # æ–‡ä»¶æ ‡é¢˜é€‰é¡¹
        for file in date_files:
            file_option = f"ğŸ“„ {file['title']}"
            sidebar_options.append(file_option)
            option_to_file[file_option] = file
    
    # ä¾§è¾¹æ å•é€‰æŒ‰é’®
    selected_sidebar = st.sidebar.radio("é€‰æ‹©æ–‡ä»¶", sidebar_options)
    
    # è·å–é€‰ä¸­æ–‡ä»¶
    selected_file = option_to_file.get(selected_sidebar)
    if not selected_file:
        st.warning("è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶")
        return
    
    # æ˜¾ç¤ºæ–‡æ¡£å†…å®¹
    cleaned_content = extract_content(selected_file['content'])
    st.markdown(cleaned_content)
    
   # æ˜¾ç¤ºåª’ä½“æ–‡ä»¶
    media_folder = selected_file['path'].replace('articles', 'files', 1).rsplit('.', 1)[0]
    
    if os.path.exists(media_folder) and os.path.isdir(media_folder):
        media_files = sorted(os.listdir(media_folder))
        
        # åˆå§‹åŒ–åˆ—çŠ¶æ€å˜é‡
        current_col_type = None
        current_columns = None
        current_col_index = 0

        for media_file in media_files:
            file_path = os.path.join(media_folder, media_file)
            ext = media_file.split('.')[-1].lower()
            
            try:
                if ext in ['png', 'jpg', 'jpeg', 'gif']:
                    # è·å–å›¾ç‰‡å°ºå¯¸
                    try:
                        with Image.open(file_path) as img:
                            width, height = img.size
                    except Exception as e:
                        st.error(f"æ— æ³•è¯»å–å›¾ç‰‡å°ºå¯¸ï¼š{media_file} - {str(e)}")
                        continue

                    # åˆ¤æ–­åˆ—ç±»å‹
                    if width < height:
                        col_type = 3
                    elif width == height:
                        col_type = 2
                    else:
                        col_type = 1

                    # åˆ†åˆ—æ˜¾ç¤ºé€»è¾‘
                    if col_type in [3, 2]:
                        if current_col_type != col_type or current_col_index >= col_type:
                            current_columns = st.columns(col_type)
                            current_col_type = col_type
                            current_col_index = 0
                        
                        with current_columns[current_col_index]:
                            st.image(file_path)
                            if show_download:
                                with open(file_path, "rb") as f:
                                    st.download_button(
                                        label=f"ä¸‹è½½",
                                        data=f.read(),
                                        file_name=media_file,
                                        mime=f"image/{ext}",
                                        key=f"img_{media_file}_{current_col_index}"
                                    )
                        current_col_index += 1
                    else:
                        # å•åˆ—æ˜¾ç¤º
                        st.image(file_path)
                        if show_download:
                            with open(file_path, "rb") as f:
                                st.download_button(
                                    label=f"ä¸‹è½½",
                                    data=f.read(),
                                    file_name=media_file,
                                    mime=f"image/{ext}",
                                    key=f"img_{media_file}"
                                )
                        # é‡ç½®åˆ—çŠ¶æ€
                        current_col_type = None
                        current_columns = None
                        current_col_index = 0

                elif ext in ['mp4', 'webm']:
                    st.video(file_path, autoplay=True, loop=True, muted=True)
                elif ext in ['mp3', 'wav']:
                    st.audio(file_path)
            except Exception as e:
                st.error(f"æ— æ³•åŠ è½½æ–‡ä»¶ {media_file}: {str(e)}")
    else:
        st.info("æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„åª’ä½“æ–‡ä»¶å¤¹")

if __name__ == "__main__":
    main()